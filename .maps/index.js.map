{"version":3,"sources":["index.es7.js"],"names":[],"mappings":"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","file":"index.es7.js","sourcesContent":["/**\n * Created by Denis Bondarenko <bond.den@gmail.com> on 14.08.2015.\n */\n\"use strict\";\n\nvar\n  Imap      =require('imap'),\n  iconv     =require('iconv'),\n  MailParser=require(\"mailparser\").MailParser,\n  inspect   =require('util').inspect,\n  path      =require('path'),\n  fs        =require('fs-extra')\n  ;\n\nimport * as modBsc from 'esf-bsc';\nimport * as modUtl from 'esf-utl';\n\nvar\n  Utl=modUtl.Utl,\n  L  =Utl.log,\n  E  =Utl.rejectingError\n  ;\n\nexport class EmlRcv extends modBsc.Bsc {\n\n  constructor(){\n    super();\n    this.stat={\n      \"operationDate\":         \"\",\n      \"operationDir\":          \"\",\n      \"messagesFound\":         0,\n      \"withAttachments\":       0,\n      \"filesReceived\":         0,\n      \"sendersTotal\":          0,\n      \"receivedFromSendersNum\":0,\n      \"attachmentsReceived\":   0,\n      \"attachmentsSaved\":      0,\n      \"attLog\":                [],\n      \"settings\":              {}\n    };\n  }\n\n  getCurrentDateTime(){\n    return Utl.getCurrentDateFmtFFS();\n  }\n\n  createFolders(folderName){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      let operationDir=path.resolve(__dirname+'/'+H.cfg.local.path+folderName);\n      fs.ensureDir(operationDir,function(e){\n\n        if(e){\n          return E(1,'Error creating dir '+operationDir,e,rj);\n        }\n\n        H.stat.operationDir=operationDir;\n\n        L(H.stat.operationDir);\n\n        let wtr=[];\n        for(let [subDirId,subDirName] of Object.entries(H.cfg.local.subDirs)){\n\n          wtr.push(\n            new Promise(function(rs1,rj1){\n\n              let subDir=path.resolve(operationDir+'/'+subDirName);\n              fs.ensureDir(subDir,function(e1){\n\n                if(e1){\n                  return E(2,'Error creating dir '+subDir,e1,rj1);\n                }\n\n                rs1(subDir);\n\n              });\n\n            })\n          );\n\n        }\n\n        Promise.all(wtr).then(function(rw){\n          rs(rw.push(operationDir));\n        }).catch(function(ew){\n          E(3,'',ew,rj);\n        });\n\n      });\n\n    });\n  }\n\n  //todo: implement esf-eml-rcv-0.3\n  processMessage(msgId,buffer,opDir){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      function detectAttachmentType(s){\n        let a=s.split('/');\n        return (Array.isArray(a)&&a.length==2)?a[1]:'';\n      }\n\n      let file=path.resolve(opDir+'/'+H.cfg.local.subDirs.raw+msgId+'.eml');\n      let psr =new MailParser();\n      let wtr =[];\n\n      psr.on(\"end\",function(eml){\n\n        let attLogItem={\n          \"msgId\":msgId,\n          \"from\": eml.from,\n          \"subj\": eml.subject,\n          \"date\": eml.date,\n          \"att\":  []\n        };\n\n        L('#'+msgId+' attachments:','em');\n\n        //fs.writeFileSync(path.resolve(opDir+'/e0/'+msgId+'.json'),JSON.stringify(eml,null,'\\t'),{encoding:\"utf8\"});\n\n        if(eml.attachments&&eml.attachments.length){\n\n          H.stat.withAttachments++;\n\n          eml.attachments.forEach(function(att,i,a){\n            L('Msg '+msgId+' has attachment: '+att.fileName);\n\n            let fileData={\n              \"ext\":      path.extname(att.fileName),\n              \"base\":     opDir+'/'+H.cfg.local.subDirs.att+msgId+'-'+i,\n              \"type\":     detectAttachmentType(att.contentType),\n              \"name\":     att.fileName,\n              \"namGen\":   att.generatedFileName,\n              \"tEncoding\":att.transferEncoding,\n              \"length\":   att.length,\n              \"checksum\": att.checksum\n            };\n\n            H.stat.attachmentsReceived++;\n\n            let filePath=path.resolve(fileData.base+fileData.ext);\n\n            if(H.cfg.rules.attachmentSubtypes.indexOf(fileData.type)=== -1)return;\n\n            wtr.push(new Promise(function(rsa,rja){\n\n              L('Saving attachment '+filePath);\n\n              fs.writeFile(\n                filePath,\n                att.content,\n                {encoding:\"utf8\"},\n                function(ea){\n\n                  if(ea){\n                    return E(101,'Error saving attachment '+filePath,ea,rja);\n                  }\n\n                  attLogItem.att.push(fileData);\n                  H.stat.attachmentsSaved++;\n                  rsa(filePath);\n\n                }\n              );\n\n            }));\n\n          });\n\n        }else{\n          wtr.push(new Promise(function(rsw,rjw){\n            rsw(true);\n          }));\n        }\n\n        Promise.all(wtr).then(function(rw){\n\n          H.stat.attLog.push(attLogItem);\n\n          rs(msgId);\n        }).catch(function(ew){\n          E(102,'Error processing msg '+msgId,ew,rj);\n        });\n\n      });\n\n      fs.writeFile(file,buffer,{encoding:\"utf8\"},function(ef){\n\n        if(ef){\n          return E(4,'Error saving raw eml '+file,ef,rj);\n        }\n\n        L(file+'\\twritten');\n\n        fs.createReadStream(file).pipe(psr);\n\n      });\n\n    });\n  }\n\n  initMailBox(){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      try{\n\n        var imap=new Imap(H.cfg.imap);\n\n        //L('Imap:\\n'+JSON.stringify(imap,null,'\\t'));\n\n        imap.once('ready',function(){\n          imap.openBox('INBOX',true,function(e1,box){\n\n            if(e1){\n              return E(5,'Error opening mail box',e1,rj);\n            }\n\n            //L('Inbox opened. box: '+JSON.stringify(box,null,'\\t'));\n\n            rs(imap);\n\n          });\n        });\n\n        imap.once('error',function(e2){\n          E(10,'IMAP Error',e2,rj);\n        });\n\n        imap.once('end',function(){\n          L('Connection ended');\n          //rs('ok','em');\n        });\n\n        imap.connect();\n\n      }catch(e0){\n        E(205,'Error opening initiating Mailbox',e0,rj);\n      }\n\n    });\n  }\n\n  checkMail(imap){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      imap.search(\n        [\n          'UNSEEN',\n          ['SINCE',H.cfg.rules.dateRange.since],\n          ['BEFORE',H.cfg.rules.dateRange.till]\n        ],\n        function(e4,searchResult){\n\n          if(e4){\n            E(6,'Error searching messages',e4,rj,true);\n          }\n\n          H.stat.messagesFound=searchResult.length;\n\n          rs(searchResult);\n\n        }\n      );\n\n    });\n  }\n\n  receiveMail(operationDir,searchResult,imap){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      let f=imap.seq.fetch(searchResult,{\n        bodies:'',\n        struct:true\n      });\n\n      let wtr=[\n        new Promise(function(rst,rjt){\n          rst(true);\n        })\n      ];\n\n      f.on('message',function(msg,num){\n\n        L('Message #'+num);\n\n        msg.on('body',function(stream,info){\n\n          var buffer='';\n          stream.on('data',function(chunk){\n            buffer+=chunk.toString('utf8');\n          });\n\n          stream.once('end',function(){\n            wtr.push(H.processMessage(num,buffer,operationDir));\n            imap.end();\n          });\n\n        });\n\n        msg.once('end',function(){\n          L('Finished fetching msg '+num);\n        });\n\n      });\n\n      f.once('error',function(e3){\n        E(7,'Fetch error',e3);\n      });\n\n      f.once('end',function(){\n\n        L('Done fetching all messages');\n        imap.end();\n\n        Promise.all(wtr).then(function(rw){\n\n          L('Done processing fetched messages.\\nSaving stat...');\n\n          fs.writeJson(H.stat.operationDir+'/stt.json',H.stat,function(es){\n\n            if(es){\n              return E(8,'Fetch error',es,rj);\n            }\n\n            L('Stat saved','em');\n            rs('Stat saved');\n\n          });\n\n        }).catch(function(ew){\n          E(9,'Fetch error',ew,rj);\n        });\n\n      });\n\n    });\n  }\n\n  splitMessagesRangeAndFetch(operationDir,searchResult,imap){\n    var H=this;\n    return new Promise(function(rs,rj){\n\n      if(!operationDir){\n        return E(207,'No folder to save attachments set');\n      }\n\n      if(searchResult.length===0){\n        H.stat.messagesFound=0;\n        L('0 new messages found');\n        return 0;\n      }\n\n      //let tmr=null;\n      let wtr=[];\n\n      let i=1;\n      let l=Math.ceil(searchResult.length/H.cfg.pcs.portion);\n      while(searchResult.length>0){\n        let portion=searchResult.splice(0,H.cfg.pcs.portion);\n        L('Fetching portion: '+i+' of '+l);\n        wtr.push(H.receiveMail(operationDir,portion,imap));\n        //tmr=setTimeout(function(){\n        //\tL('Fetching portion: '+portion);\n        //\twtr.push(H.receiveMail(operationDir,portion));\n        //},H.cfg.pcs.interPortionDelayMs);\n        i++;\n      }\n\n      Promise.all(wtr).then(function(rw){\n        rs('All Portions fetched succssfully');\n      }).catch(function(ew){\n        E(208,'Error fetching portion ',ew,rj);\n      });\n\n    });\n  }\n\n  run(){\n\n    var H=this;\n\n    return new Promise(function(rsT,rjT){\n\n      L('Loading config...');\n\n      H.loadConfig().then(function(cfg){\n\n        L('Successfully loaded config');\n        //L(H.cfg);\n\n        H.stat.operationDate=H.getCurrentDateTime();\n        H.stat.sendersTotal =H.cfg.rules.from.list.length;\n\n        let timeoutTrigger=new Promise(function(rs,rj){\n          setTimeout(function(){\n            rj(new Error('Timeout '+H.cfg.pcs.totalTimeout+' exceeded'));\n          },H.cfg.pcs.totalTimeout);\n        });\n\n        let mainFlow=new Promise(function(rs,rj){\n\n          L('Operation date: '+H.stat.operationDate);\n          L('Cleaning caches...');\n\n          //todo: implement clearPaths bool\n          fs.emptyDir(path.resolve(__dirname+'/'+H.cfg.local.path),function(e5){\n\n            if(e5){\n              return E(11,'Error cleaning dirs',e5,rj);\n            }\n\n            L('Cleaning caches: ready');\n            L('Creating tmp folders...');\n\n            H.createFolders(H.stat.operationDate).then(function(dirs){\n\n              L('Tmp folder created: '+JSON.stringify(dirs));\n              L('Initializing  MailBox...');\n\n              H.initMailBox().then(function(imap){\n\n                L('MailBox initialized');\n                L('Checking mail...');\n\n                H.checkMail(imap).then(function(searchResult){\n\n                  L('Mail checked. Found '+searchResult.length+' messages');\n                  L('Fetching mail...');\n\n                  H.splitMessagesRangeAndFetch(H.stat.operationDir,searchResult,imap).then(function(rf){\n\n                    L('Mail successfully fetched');\n                    rs(rf);\n\n                  }).catch(function(e5){\n                    E(16,'Error fetching mail',e5,rj);\n                  });\n\n                }).catch(function(e4){\n                  E(15,'Error checking mail',e4,rj);\n                });\n\n              }).catch(function(e3){\n                E(12,'Error initializing MailBox',e3,rj);\n              });\n\n            }).catch(function(e2){\n              E(13,'Error creating folders',e2,rj);\n            });\n\n          });\n\n        });\n\n        Promise.race([\n          mainFlow,\n          timeoutTrigger\n        ]).then(function(rT){\n          rsT(rT);\n        }).catch(function(eT){\n          E(20,'',eT,rjT);\n        });\n\n      });\n\n    });\n\n  }\n\n}\n"],"sourceRoot":"/source/"}