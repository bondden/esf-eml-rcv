{"version":3,"sources":["index.es7.js"],"names":[],"mappings":"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","file":"index.es7.js","sourcesContent":["/**\n * Created by Denis Bondarenko <bond.den@gmail.com> on 14.08.2015.\n */\n\"use strict\";\n\nconst\n  Imap      =require('imap'),\n  iconv     =require('iconv'),\n  MailParser=require(\"mailparser\").MailParser,\n  //inspect   =require('util').inspect,\n  path      =require('path'),\n  fs        =require('fs-extra')\n  ;\n\nimport * as modBsc from 'esf-bsc';\nimport * as modUtl from 'esf-utl';\n\nconst\n  U=modUtl.Utl,\n  L=U.log,\n  E=U.rejectingError\n  ;\n\nexport class EmlRcv extends modBsc.Bsc {\n\n  constructor(){\n    super();\n    this.stat={\n      operationDate:         '',\n      operationDir:          '',\n      messagesFound:         0,\n      withAttachments:       0,\n      filesReceived:         0,\n      sendersTotal:          0,\n      receivedFromSendersNum:0,\n      attachmentsReceived:   0,\n      attachmentsSaved:      0,\n      attLog:                [],\n      settings:              {}\n    };\n  }\n\n  getCurrentDateTime(){\n    return U.getCurrentDateFmtFFS();\n  }\n  \n  getRtPth(p){\n    return path.isAbsolute(p)?p:`${__dirname}/${p}`;\n  }\n\n  createFolders(folderName){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      let operationDir=path.resolve(this.getRtPth(H.cfg.local.path)+folderName);\n      fs.ensureDir(operationDir,e=>{\n\n        if(e){\n          return E(1,'Error creating dir '+operationDir,e,rj);\n        }\n\n        H.stat.operationDir=operationDir;\n\n        L(H.stat.operationDir);\n\n        let wtr=[];\n        for(let subDirId in H.cfg.local.subDirs){\n\n          if(!H.cfg.local.subDirs.hasOwnProperty(subDirId))return;\n\n          let subDirName=H.cfg.local.subDirs[subDirId];\n          wtr.push(\n            new Promise((rs1,rj1)=>{\n\n              let subDir=path.resolve(operationDir+'/'+subDirName);\n              fs.ensureDir(subDir,e1=>{\n\n                if(e1){\n                  return E(2,'Error creating dir '+subDir,e1,rj1);\n                }\n\n                rs1(subDir);\n\n              });\n\n            })\n          );\n\n        }\n\n        Promise\n          .all(wtr)\n          .then(rw=>{\n            rs(rw.push(operationDir));\n          })\n          .catch(ew=>{\n            E(3,'',ew,rj);\n          })\n        ;\n\n      });\n\n    });\n  }\n\n  //todo: implement esf-eml-rcv-0.3\n  processMessage(msgId,buffer,opDir){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      L(`Processing msg #${msgId}...`);\n\n      function detectAttachmentType(s){\n        let a=s.split('/');\n        return (Array.isArray(a)&&a.length==2)?a[1]: '';\n      }\n\n      let file=path.resolve(opDir+'/'+H.cfg.local.subDirs.raw+msgId+'.eml');\n      let psr =new MailParser();\n      let wtr =[];\n\n      psr.on('end',eml=>{\n\n        let attLogItem={\n          msgId:msgId,\n          from: eml.from,\n          subj: eml.subject,\n          date: eml.date,\n          att:  []\n        };\n\n        //fs.writeFileSync(path.resolve(opDir+'/e0/'+msgId+'.json'),JSON.stringify(eml,null,'\\t'),{encoding:\"utf8\"});\n\n        if(eml.attachments&&eml.attachments.length){\n\n          L('#'+msgId+' attachments:','em');\n\n          H.stat.withAttachments++;\n\n          eml.attachments.forEach((att,i,a)=>{\n            \n            if(!att.fileName)return;\n            L(`Msg ${msgId} has attachment: ${att.fileName}`);\n\n            let fileData={\n              ext:      path.extname(att.fileName),\n              base:     opDir+'/'+H.cfg.local.subDirs.att+msgId+'-'+i,\n              type:     detectAttachmentType(att.contentType),\n              name:     att.fileName,\n              namGen:   att.generatedFileName,\n              tEncoding:att.transferEncoding,\n              length:   att.length,\n              checksum: att.checksum\n            };\n\n            H.stat.attachmentsReceived++;\n\n            let filePath=path.resolve(fileData.base+fileData.ext);\n\n            if(H.cfg.rules.attachmentSubtypes.indexOf(fileData.type)=== -1)return;\n\n            wtr.push(new Promise((rsa,rja)=>{\n\n              L('Saving attachment '+filePath);\n\n              fs.writeFile(\n                filePath,\n                att.content,\n                {encoding:\"utf8\"},\n                ea=>{\n\n                  if(ea){\n                    return E(101,'Error saving attachment '+filePath,ea,rja);\n                  }\n\n                  attLogItem.att.push(fileData);\n                  H.stat.attachmentsSaved++;\n                  rsa(filePath);\n\n                }\n              );\n\n            }));\n\n          });\n\n        }else{\n          wtr.push(new Promise((rsw,rjw)=>{\n            rsw(true);\n          }));\n        }\n\n        Promise\n          .all(wtr)\n          .then(rw=>{\n\n            H.stat.attLog.push(attLogItem);\n\n            rs(msgId);\n          })\n          .catch(ew=>{\n            E(102,'Error processing msg '+msgId,ew,rj);\n          })\n        ;\n\n      });\n\n      fs.writeFile(file,buffer,{encoding:\"utf8\"},ef=>{\n\n        if(ef){\n          return E(4,'Error saving raw eml '+file,ef,rj);\n        }\n\n        L(file+'\\twritten');\n\n        fs.createReadStream(file).pipe(psr);\n\n      });\n\n    });\n  }\n\n  initMailBox(){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      try{\n\n        var imap=new Imap(H.cfg.imap);\n\n        imap.once('ready',()=>{\n          imap.openBox('INBOX',true,(e1,box)=>{\n\n            if(e1){\n              return E(5,'Error opening mail box',e1,rj);\n            }\n\n            rs(imap);\n\n          });\n        });\n\n        imap.once('error',e2=>{\n          E(10,'IMAP Error',e2,rj);\n        });\n\n        imap.once('end',()=>{\n          L('Connection ended');\n          //rs('ok','em');\n        });\n\n        imap.connect();\n\n      }catch(e0){\n        E(205,'Error opening initiating Mailbox',e0,rj);\n      }\n\n    });\n  }\n\n  checkMail(imap){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      imap.search(\n        [\n          H.cfg.rules.flag,\n          ['SINCE',H.cfg.rules.dateRange.since],\n          ['BEFORE',H.cfg.rules.dateRange.till]\n        ],\n        (e4,searchResult)=>{\n\n          if(e4){\n            E(6,'Error searching messages',e4,rj,true);\n          }\n\n          H.stat.messagesFound=searchResult.length;\n\n          rs(searchResult);\n\n        }\n      );\n\n    });\n  }\n\n  receiveMail(operationDir,searchResultPortion,imap){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      //L(`Receiving mail ${Array.isArray(searchResultPortion)?searchResultPortion.join(','): ''}...`);\n      L(`Receiving mail...`);\n\n      let wtr=[\n        new Promise((rst,rjt)=>{\n          setTimeout(\n            ()=>{\n              rst(true);\n            },\n            1000\n          );\n        })\n      ];\n\n      let f=imap.fetch(\n        searchResultPortion,\n        {\n          bodies:'',\n          struct:true\n        }\n      );\n\n      L(f);\n\n      f.on('message',(msg,num)=>{\n\n        L('Message #'+num);\n\n        msg.on('body',(stream,info)=>{\n\n          var buffer='';\n          stream.on('data',chunk=>{\n            buffer+=chunk.toString('utf8');\n          });\n\n          stream.once('end',()=>{\n\n            wtr.push(H.processMessage(num,buffer,operationDir));\n\n            //imap.end();\n          });\n\n        });\n\n        msg.once('end',()=>{\n          L('Finished fetching msg '+num);\n        });\n\n      });\n\n      f.once('error',e3=>{\n        return E(7,'Fetch error',e3,rj);\n      });\n\n      f.once('end',()=>{\n\n        L('Done receiving all messages');\n        //imap.end();\n\n        Promise\n          .all(wtr)\n          .then(rw=>{\n            \n            L('closing imap');\n            imap.end();\n\n            L('Done processing fetched messages.\\nSaving stat...');\n            L(`wtr.length: ${wtr.length}`);\n            L(`rw: ${rw}`);\n\n            fs.writeJson(H.stat.operationDir+'/stt.json',H.stat,es=>{\n\n              if(es){\n                return E(8,'Fetch error',es,rj);\n              }\n\n              L('Stat saved','em');\n              \n              L('Closing the box...');\n              imap.closeBox(ec=>{\n               \n                if(ec){\n                  return E(10,'Close box error',ec,rj);\n                }\n               \n              });\n              \n              rs('Done');\n\n            });\n\n          })\n          .catch(ew=>{\n            return E(9,'Fetch error',ew,rj);\n          })\n        ;\n\n      });\n\n    });\n  }\n\n  splitMessagesRangeAndFetch(operationDir,searchResult,imap){\n    var H=this;\n    return new Promise((rs,rj)=>{\n\n      if(!operationDir){\n        return E(207,'No folder to save attachments set');\n      }\n\n      if(searchResult.length===0){\n        H.stat.messagesFound=0;\n        L('0 new messages found');\n        rs(0);\n      }\n\n      let wtr=[];\n\n      let i=1;\n      let l=Math.ceil(searchResult.length/H.cfg.pcs.portion);\n      while(searchResult.length>0){\n\n        L('Fetching portion: '+i+' of '+l);\n\n        let portion=searchResult.splice(0,H.cfg.pcs.portion);\n\n        L(`Extracted the portion: ${portion} of ${searchResult}`);\n\n        wtr.push(H.receiveMail(operationDir,portion,imap));\n\n        i++;\n\n      }\n\n      Promise\n        .all(wtr)\n        .then(rw=>{\n          L('All Portions fetched successfully');\n          rs(true);\n        })\n        .catch(ew=>{\n          E(208,'Error fetching portion ',ew,rj);\n        })\n      ;\n\n    });\n  }\n\n  run(cfgObj=null){\n\n    var H=this;\n\n    return new Promise((rsT,rjT)=>{\n\n      L('Loading config...');\n\n      H.loadConfig(cfgObj)\n       .then(cfg=>{\n\n         L('Successfully loaded config');\n         //L(H.cfg);\n\n         H.stat.operationDate=H.getCurrentDateTime();\n         H.stat.sendersTotal =H.cfg.rules.from.list.length;\n\n         let timeoutTrigger=new Promise((rs,rj)=>{\n           setTimeout(\n             ()=>{\n               rj(new Error('Timeout '+H.cfg.pcs.totalTimeout+' exceeded'));\n             },\n             H.cfg.pcs.totalTimeout\n           );\n         });\n\n         let mainFlow=new Promise((rs,rj)=>{\n\n           L('Operation date: '+H.stat.operationDate);\n           L('Cleaning caches...');\n\n           //todo: implement clearPaths bool\n           \n           fs.emptyDir(path.resolve(this.getRtPth(H.cfg.local.path)),e5=>{\n\n             if(e5){\n               return E(11,'Error cleaning dirs',e5,rj);\n             }\n\n             L('Cleaning caches: ready');\n             L('Creating tmp folders...');\n\n             H.createFolders(H.stat.operationDate)\n              .then(dirs=>{\n\n                L('Tmp folder created: '+JSON.stringify(dirs));\n                L('Initializing  MailBox...');\n\n                H.initMailBox()\n                 .then(imap=>{\n\n                   L('MailBox initialized');\n                   L('Checking mail...');\n\n                   H.checkMail(imap)\n                    .then(searchResult=>{\n\n                      L(`Mail checked. Found ${searchResult.length} messages`);\n                      L('Fetching mail...');\n\n                      H.splitMessagesRangeAndFetch(H.stat.operationDir,searchResult,imap)\n                       .then(rf=>{\n\n                         L('Mail successfully fetched');\n                         rs(rf);\n\n                       })\n                       .catch(e5=>{\n                         E(16,'Error fetching mail',e5,rj);\n                       })\n                      ;\n\n                    })\n                    .catch(e4=>{\n                      E(15,'Error checking mail',e4,rj);\n                    })\n                   ;\n\n                 })\n                 .catch(e3=>{\n                   E(12,'Error initializing MailBox',e3,rj);\n                 })\n                ;\n\n              })\n              .catch(e2=>{\n                E(13,'Error creating folders',e2,rj);\n              })\n             ;\n\n           });\n\n         });\n\n         Promise.race([\n           mainFlow,\n           timeoutTrigger\n         ])\n          .then(rT=>{\n            rsT(rT);\n          })\n          .catch(eT=>{\n            E(20,'',eT,rjT);\n          })\n         ;\n\n       });\n\n    });\n\n  }\n\n}\n"],"sourceRoot":"/source/"}